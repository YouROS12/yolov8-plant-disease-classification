# -*- coding: utf-8 -*-
"""final_exp_plantwild_cuSVM

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1NO2djaabKvoZpQXY-pAhhBZ6B9yCaBLB

**SETUP AND CONFIGURATION**
"""

# Mount Google Drive
from google.colab import drive
drive.mount('/content/drive')

# ==============================================================================
# SECTION 1: SETUP AND CONFIGURATION
# ==============================================================================
# This cell contains all initial setup, imports, and configurations.

import pandas as pd
import numpy as np
import pickle
import os
import time
import joblib
import glob
import matplotlib.pyplot as plt
import seaborn as sns
import gc # For garbage collection
from sklearn.decomposition import PCA # Using standard PCA with a robust solver

# --- Sklearn and ML Imports ---
from sklearn.preprocessing import LabelEncoder
from sklearn.decomposition import IncrementalPCA # Using IncrementalPCA for robustness against overflow
from sklearn.model_selection import GridSearchCV
from sklearn.metrics import confusion_matrix, accuracy_score, f1_score, classification_report
from sklearn.calibration import calibration_curve

# --- Classifier Imports ---
# Using sklearn.svm.SVC as fallback for CPU with probability=True
from sklearn.svm import SVC
from xgboost import XGBClassifier
from sklearn.ensemble import RandomForestClassifier
from sklearn.neural_network import MLPClassifier

# --- Main Configuration ---
DRIVE_BASE_PATH = '/content/drive/MyDrive'
RAW_DATA_PATH = os.path.join(DRIVE_BASE_PATH, 'plantwild_split')
RESULTS_SAVE_PATH = os.path.join(DRIVE_BASE_PATH, 'PlantWild_25_Nov_Latest') # New folder for this robust version
os.makedirs(RESULTS_SAVE_PATH, exist_ok=True)
print(f"All results will be saved in: {RESULTS_SAVE_PATH}")

# --- Raw Feature Pickle File Paths ---
TRAIN_PKL_PATH = os.path.join(RAW_DATA_PATH, 'df_train_features.pkl')
TEST_PKL_PATH = os.path.join(RAW_DATA_PATH, 'df_test_features.pkl')
ORIGINAL_LABEL_COLUMN = 'label'

# --- Define Class Mappings ---
visual_class_mapping = { "wheat stripe rust": "rust", "wheat stem rust": "rust", "wheat leaf rust": "rust", "soybean rust": "rust", "raspberry yellow rust": "rust", "peach rust": "rust", "plum rust": "rust", "garlic rust": "rust", "corn rust": "rust", "coffee leaf rust": "rust", "blueberry rust": "rust", "bean rust": "rust", "apple rust": "rust", "wheat powdery mildew": "powdery_mildew", "zucchini powdery mildew": "powdery_mildew", "squash powdery mildew": "powdery_mildew", "cherry powdery mildew": "powdery_mildew", "cucumber powdery mildew": "powdery_mildew", "bell pepper powdery mildew": "powdery_mildew", "zucchini downy mildew": "downy_mildew", "soybean downy mildew": "downy_mildew", "lettuce downy mildew": "downy_mildew", "grape downy mildew": "downy_mildew", "cabbage downy mildew": "downy_mildew", "broccoli downy mildew": "downy_mildew", "basil downy mildew": "downy_mildew", "tomato late blight": "blight", "tomato early blight": "blight", "raspberry fire blight": "blight", "potato late blight": "blight", "potato early blight": "blight", "corn northern leaf blight": "blight", "eggplant phytophthora blight": "blight", "garlic leaf blight": "blight", "celery early blight": "blight", "carrot alternaria leaf blight": "blight", "blueberry botrytis blight": "blight", "bean halo blight": "blight", "soybean bacterial blight": "blight", "ginger sheath blight": "blight", "rice sheath blight": "blight", "rice blast": "blight", "tomato bacterial leaf spot": "leaf_spot", "tomato septoria leaf spot": "leaf_spot", "tobacco frogeye leaf spot": "leaf_spot", "soybean frog eye leaf spot": "leaf_spot", "tobacco brown spot": "leaf_spot", "soybean brown spot": "leaf_spot", "raspberry leaf spot": "leaf_spot", "plum bacterial spot": "leaf_spot", "ginger leaf spot": "leaf_spot", "grape leaf spot": "leaf_spot", "cucumber angular leaf spot": "leaf_spot", "eggplant cercospora leaf spot": "leaf_spot", "cherry leaf spot": "leaf_spot", "coffee brown eye spot": "leaf_spot", "corn gray leaf spot": "leaf_spot", "cauliflower alternaria leaf spot": "leaf_spot", "carrot cercospora leaf blight": "leaf_spot", "broccoli ring spot": "leaf_spot", "cabbage alternaria leaf spot": "leaf_spot", "bell pepper frogeye leaf spot": "leaf_spot", "broccoli alternaria leaf spot": "leaf_spot", "bell pepper bacterial spot": "leaf_spot", "banana black leaf streak": "leaf_spot", "banana cordana leaf spot": "leaf_spot", "maple tar spot": "leaf_spot", "zucchini yellow mosaic virus": "virus", "tomato mosaic virus": "virus", "tomato yellow leaf curl virus": "virus", "tobacco mosaic virus": "virus", "soybean mosaic": "virus", "plum pox virus": "virus", "lettuce mosaic virus": "virus", "grapevine leafroll disease": "virus", "citrus greening disease": "virus", "banana bunchy top": "virus", "bean mosaic virus": "virus", "apple mosaic virus": "virus", "peach brown rot": "rot", "plum brown rot": "rot", "grape black rot": "rot", "eggplant phomopsis fruit rot": "rot", "coffee black rot": "rot", "cabbage black rot": "rot", "cauliflower bacterial soft rot": "rot", "bell pepper blossom end rot": "rot", "banana cigar end rot": "rot", "apple black rot": "rot", "strawberry anthracnose": "anthracnose", "peach anthracnose": "anthracnose", "celery anthracnose": "anthracnose", "blueberry anthracnose": "anthracnose", "banana anthracnose": "anthracnose", "wheat head scab": "scab", "peach scab": "scab", "apple scab": "scab", "zucchini bacterial wilt": "bacterial_disease", "wheat bacterial leaf streak (black chaff)": "bacterial_disease", "cucumber bacterial wilt": "bacterial_disease", "citrus canker": "bacterial_disease", "tomato leaf mold": "mold", "tobacco blue mold": "mold", "raspberry gray mold": "mold", "wheat septoria blotch": "septoria_blotch", "wheat loose smut": "smut", "corn smut": "smut", "strawberry leaf scorch": "leaf_scorch", "blueberry scorch": "leaf_scorch", "plum pocket disease": "fungal_gall", "peach leaf curl": "fungal_gall", "blueberry mummy berry": "mummy_berry", "banana panama disease": "fungal_wilt", "carrot cavity spot": "oomycete_lesion", "coffee berry blotch": "berry_blotch",}
treatment_based_mapping = { "wheat stripe rust": "fungal_rust", "wheat stem rust": "fungal_rust", "wheat leaf rust": "fungal_rust", "soybean rust": "fungal_rust", "raspberry yellow rust": "fungal_rust", "peach rust": "fungal_rust", "plum rust": "fungal_rust", "garlic rust": "fungal_rust", "corn rust": "fungal_rust", "coffee leaf rust": "fungal_rust", "blueberry rust": "fungal_rust", "bean rust": "fungal_rust", "apple rust": "fungal_rust", "wheat powdery mildew": "fungal_powdery_mildew", "zucchini powdery mildew": "fungal_powdery_mildew", "squash powdery mildew": "fungal_powdery_mildew", "cherry powdery mildew": "fungal_powdery_mildew", "cucumber powdery mildew": "fungal_powdery_mildew", "bell pepper powdery mildew": "fungal_powdery_mildew", "zucchini downy mildew": "fungal_downy_mildew", "soybean downy mildew": "fungal_downy_mildew", "lettuce downy mildew": "fungal_downy_mildew", "grape downy mildew": "fungal_downy_mildew", "cabbage downy mildew": "fungal_downy_mildew", "broccoli downy mildew": "fungal_downy_mildew", "basil downy mildew": "fungal_downy_mildew", "wheat septoria blotch": "fungal_leaf_disease", "tomato leaf mold": "fungal_leaf_disease", "tomato septoria leaf spot": "fungal_leaf_disease", "tomato late blight": "fungal_leaf_disease", "tomato early blight": "fungal_leaf_disease", "tobacco frogeye leaf spot": "fungal_leaf_disease", "soybean frog eye leaf spot": "fungal_leaf_disease", "strawberry leaf scorch": "fungal_leaf_disease", "tobacco blue mold": "fungal_leaf_disease", "tobacco brown spot": "fungal_leaf_disease", "strawberry anthracnose": "fungal_leaf_disease", "soybean brown spot": "fungal_leaf_disease", "raspberry leaf spot": "fungal_leaf_disease", "potato late blight": "fungal_leaf_disease", "rice blast": "fungal_leaf_disease", "potato early blight": "fungal_leaf_disease", "raspberry gray mold": "fungal_leaf_disease", "peach scab": "fungal_leaf_disease", "peach anthracnose": "fungal_leaf_disease", "peach leaf curl": "fungal_leaf_disease", "grape leaf spot": "fungal_leaf_disease", "ginger leaf spot": "fungal_leaf_disease", "maple tar spot": "fungal_leaf_disease", "corn northern leaf blight": "fungal_leaf_disease", "eggplant phytophthora blight": "fungal_leaf_disease", "eggplant cercospora leaf spot": "fungal_leaf_disease", "garlic leaf blight": "fungal_leaf_disease", "cherry leaf spot": "fungal_leaf_disease", "coffee brown eye spot": "fungal_leaf_disease", "corn gray leaf spot": "fungal_leaf_disease", "celery early blight": "fungal_leaf_disease", "cauliflower alternaria leaf spot": "fungal_leaf_disease", "celery anthracnose": "fungal_leaf_disease", "carrot alternaria leaf blight": "fungal_leaf_disease", "carrot cercospora leaf blight": "fungal_leaf_disease", "broccoli ring spot": "fungal_leaf_disease", "cabbage alternaria leaf spot": "fungal_leaf_disease", "blueberry botrytis blight": "fungal_leaf_disease", "bell pepper frogeye leaf spot": "fungal_leaf_disease", "broccoli alternaria leaf spot": "fungal_leaf_disease", "blueberry anthracnose": "fungal_leaf_disease", "blueberry scorch": "fungal_leaf_disease", "banana panama disease": "fungal_leaf_disease", "banana black leaf streak": "fungal_leaf_disease", "banana cordana leaf spot": "fungal_leaf_disease", "banana anthracnose": "fungal_leaf_disease", "apple scab": "fungal_leaf_disease", "rice sheath blight": "fungal_leaf_disease", "ginger sheath blight": "fungal_leaf_disease", "peach brown rot": "fungal_rot_fruit_disease", "plum brown rot": "fungal_rot_fruit_disease", "grape black rot": "fungal_rot_fruit_disease", "eggplant phomopsis fruit rot": "fungal_rot_fruit_disease", "coffee black rot": "fungal_rot_fruit_disease", "blueberry mummy berry": "fungal_rot_fruit_disease", "banana cigar end rot": "fungal_rot_fruit_disease", "apple black rot": "fungal_rot_fruit_disease", "coffee berry blotch": "fungal_rot_fruit_disease", "bell pepper blossom end rot": "abiotic_disorder", "wheat loose smut": "fungal_systemic_smut_gall", "corn smut": "fungal_systemic_smut_gall", "plum pocket disease": "fungal_systemic_smut_gall", "zucchini bacterial wilt": "bacterial_disease", "tomato bacterial leaf spot": "bacterial_disease", "wheat bacterial leaf streak (black chaff)": "bacterial_disease", "soybean bacterial blight": "bacterial_disease", "plum bacterial spot": "bacterial_disease", "cucumber angular leaf spot": "bacterial_disease", "cucumber bacterial wilt": "bacterial_disease", "citrus canker": "bacterial_disease", "citrus greening disease": "bacterial_disease", "cabbage black rot": "bacterial_disease", "cauliflower bacterial soft rot": "bacterial_disease", "bean halo blight": "bacterial_disease", "bell pepper bacterial spot": "bacterial_disease", "raspberry fire blight": "bacterial_disease", "zucchini yellow mosaic virus": "viral_disease", "tomato mosaic virus": "viral_disease", "tomato yellow leaf curl virus": "viral_disease", "tobacco mosaic virus": "viral_disease", "soybean mosaic": "viral_disease", "plum pox virus": "viral_disease", "lettuce mosaic virus": "viral_disease", "grapevine leafroll disease": "viral_disease", "banana bunchy top": "viral_disease", "bean mosaic virus": "viral_disease", "apple mosaic virus": "viral_disease", "carrot cavity spot": "oomycete_lesion", "wheat head scab": "fungal_scab",}
EXPERIMENT_MAPPINGS = { "visual_grouping": visual_class_mapping, "treatment_grouping": treatment_based_mapping }

print("Setup complete.")

# ==============================================================================
# FINAL DEEP-DIVE ANALYSIS ON THE CHAMPION MODEL (FIXED)
# ==============================================================================
# üëë Champion Config: cuSVM | n_components=100 | treatment_grouping
# üö© Context: Relies on paths and mappings defined in SECTION 1.

# --- 1. Additional Imports for Analysis ---
import gc
import warnings
from sklearn.preprocessing import StandardScaler
from sklearn.decomposition import PCA
from sklearn.metrics import classification_report, accuracy_score, f1_score, confusion_matrix
from sklearn.calibration import calibration_curve

# Install/Import cuML
try:
    import cuml
    from cuml.svm import SVC as cuSVC
    print("‚úÖ cuML imported successfully for GPU acceleration.")
except ImportError:
    print("‚ö†Ô∏è cuML not found. Installing...")
    !pip install cuml-cu12 --extra-index-url=https://pypi.nvidia.com
    import cuml
    from cuml.svm import SVC as cuSVC

warnings.filterwarnings("ignore")

# --- 2. Configuration ---
CHAMPION_N_COMPONENTS = 100
CHAMPION_PARAMS_CUSVM = {'C': 1, 'gamma': 'scale', 'class_weight': 'balanced'}
CHAMPION_PARAMS_SKLEARN = {'C': 1, 'gamma': 'scale', 'class_weight': 'balanced'}

# Define Output Path
ANALYSIS_OUTPUT_PATH = os.path.join(RESULTS_SAVE_PATH, 'Champion_Analysis_Deep_Dive')
os.makedirs(ANALYSIS_OUTPUT_PATH, exist_ok=True)

print(f"\nüìÇ Analysis Output Directory: {ANALYSIS_OUTPUT_PATH}")
print(f"‚öôÔ∏è  Model: cuSVM | PCA Components: {CHAMPION_N_COMPONENTS}")

# --- 3. Safety Check: Mapping Completeness ---
missing_keys_patch = {
    "apple scab": "fungal_leaf_disease", "banana anthracnose": "fungal_leaf_disease",
    "banana panama disease": "fungal_leaf_disease", "blueberry anthracnose": "fungal_leaf_disease",
    "ginger sheath blight": "fungal_leaf_disease", "rice sheath blight": "fungal_leaf_disease",
    "blueberry scorch": "viral_disease"
}
for k, v in missing_keys_patch.items():
    if k not in treatment_based_mapping:
        treatment_based_mapping[k] = v

# --- 4. Data Loading & Preprocessing ---
print(f"\nüîÑ Loading Feature Data from: {os.path.basename(TRAIN_PKL_PATH)}...")
with open(TRAIN_PKL_PATH, 'rb') as f: df_train = pd.DataFrame(pickle.load(f))
with open(TEST_PKL_PATH, 'rb') as f: df_test = pd.DataFrame(pickle.load(f))

# Flatten & Scale
print("   Flattening and Scaling...")
X_train_flat = np.stack(df_train['image'].tolist()).reshape(len(df_train), -1)
X_test_flat = np.stack(df_test['image'].tolist()).reshape(len(df_test), -1)

scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train_flat)
X_test_scaled = scaler.transform(X_test_flat)

# PCA
print(f"   Applying PCA (n={CHAMPION_N_COMPONENTS})...")
final_pca = PCA(n_components=CHAMPION_N_COMPONENTS, svd_solver='randomized', random_state=42)
X_train_pca = final_pca.fit_transform(X_train_scaled)
X_test_pca = final_pca.transform(X_test_scaled)

# Labels
le = LabelEncoder()
y_train = le.fit_transform(df_train[ORIGINAL_LABEL_COLUMN].map(treatment_based_mapping))
y_test = le.transform(df_test[ORIGINAL_LABEL_COLUMN].map(treatment_based_mapping))

# Cleanup
del X_train_flat, X_test_flat, X_train_scaled, X_test_scaled, df_train, df_test
gc.collect()

# ==============================================================================
# --- 5. EXECUTION: CHAMPION MODEL ---
# ==============================================================================

# A. Train cuSVM
print(f"\nüöÄ Training Champion cuSVM {CHAMPION_PARAMS_CUSVM}...")
model_cu = cuSVC(**CHAMPION_PARAMS_CUSVM, random_state=42)
model_cu.fit(X_train_pca, y_train)

# FIXED LINE: Removed .to_numpy() because cuML already returns a numpy array here
y_pred = model_cu.predict(X_test_pca)

# B. Metrics & Reports
acc = accuracy_score(y_test, y_pred)
f1 = f1_score(y_test, y_pred, average='macro')
print(f"\nüèÜ FINAL RESULTS:\n   Accuracy: {acc:.4f}\n   F1-Macro: {f1:.4f}")

report_df = pd.DataFrame(classification_report(y_test, y_pred, target_names=le.classes_, output_dict=True)).T.round(4)
report_csv_path = os.path.join(ANALYSIS_OUTPUT_PATH, 'champion_classification_report.csv')
report_df.to_csv(report_csv_path)
print(f"   Detailed report saved to: {report_csv_path}")

# C. Confusion Matrix
cm = confusion_matrix(y_test, y_pred)
cm_norm = cm.astype('float') / cm.sum(axis=1)[:, np.newaxis]
plt.figure(figsize=(14, 12))
sns.heatmap(cm_norm, annot=True, fmt='.2f', cmap='viridis', xticklabels=le.classes_, yticklabels=le.classes_)
plt.title(f'Normalized Confusion Matrix\ncuSVM (Acc={acc:.4f})', fontsize=16)
plt.xlabel('Predicted'); plt.ylabel('True')
plt.savefig(os.path.join(ANALYSIS_OUTPUT_PATH, 'champion_confusion_matrix.png'), dpi=300, bbox_inches='tight')
plt.show()

# ==============================================================================
# --- 6. ROBUSTNESS & CALIBRATION (Sklearn Fallback) ---
# ==============================================================================
print("\nüîç Running Robustness & Probability Analysis (using Sklearn CPU implementation)...")

# Robustness on 3 seeds
seeds = [42, 123, 7]
robust_f1s = []
for s in tqdm(seeds, desc="Robustness Seeds"):
    m = SVC(**CHAMPION_PARAMS_SKLEARN, probability=True, random_state=s)
    m.fit(X_train_pca, y_train)
    robust_f1s.append(f1_score(y_test, m.predict(X_test_pca), average='macro'))

print(f"   Robustness (3 runs): Mean F1={np.mean(robust_f1s):.4f} ¬± {np.std(robust_f1s):.4f}")

# Reliability Diagram
# (m is the last trained model from the loop)
probas = m.predict_proba(X_test_pca)
conf = np.max(probas, axis=1)
accs = (m.predict(X_test_pca) == y_test)
frac_pos, mean_conf = calibration_curve(accs, conf, n_bins=10)

plt.figure(figsize=(6, 6))
plt.plot(mean_conf, frac_pos, "s-", label="Champion Config")
plt.plot([0, 1], [0, 1], "k--", label="Perfectly Calibrated")
plt.xlabel("Mean Confidence"); plt.ylabel("Fraction Correct"); plt.title("Reliability Diagram")
plt.legend(); plt.grid(True)
plt.savefig(os.path.join(ANALYSIS_OUTPUT_PATH, 'champion_reliability_diagram.png'))
plt.show()

print("\n‚úÖ Deep-dive analysis complete.")

# ==============================================================================
# UTILITY SCRIPT: Read all CSVs and Print as LaTeX Tables
# ==============================================================================
import os
import pandas as pd
import glob

# --- CONFIGURATION ---
# Set the path to the main folder containing all your results.
# This should be the parent folder that contains subfolders like 'final_analysis_champion_n100', etc.
SEARCH_PATH = '/content/drive/MyDrive/PlantWild_Final_Unified_Results_Robust/Champion_Analysis_Deep_Dive' #<-- MAKE SURE THIS IS YOUR CORRECT RESULTS FOLDER

print(f"--- Searching for all .csv files in: {SEARCH_PATH} ---")

# Use glob to find all .csv files recursively in all subdirectories
csv_files = glob.glob(os.path.join(SEARCH_PATH, '**', '*.csv'), recursive=True)

if not csv_files:
    print("\nNo .csv files found. Please check the SEARCH_PATH.")
else:
    print(f"\nFound {len(csv_files)} CSV files. Generating LaTeX tables for each...\n")

    for file_path in sorted(csv_files):
        try:
            # Read the CSV file into a pandas DataFrame
            df = pd.read_csv(file_path)

            print("#" * 80)
            # Print a clear header with the filename
            print(f"# LaTeX Table for: {os.path.relpath(file_path, DRIVE_BASE_PATH)}")
            print("#" * 80)

            # --- Formatting Options ---
            # We will try to make the table look nice by rounding floats
            # and setting a good caption and label.
            float_cols = df.select_dtypes(include='float').columns
            df[float_cols] = df[float_cols].round(4)

            # Generate the LaTeX string from the DataFrame
            latex_string = df.to_latex(
                index=False,  # Don't include the pandas index column
                caption=f"Results from {os.path.basename(file_path)}.", # Auto-generate a caption
                label=f"tab:{os.path.basename(file_path).replace('.csv', '')}" # Auto-generate a label
            )

            print(latex_string)
            print("\n\n")

        except Exception as e:
            print(f"\n--- Could not process file: {os.path.basename(file_path)} ---")
            print(f"Error: {e}\n")

print("--- All found CSV files have been processed. ---")

import os

def print_folder_structure(root_folder):
    for root, dirs, files in os.walk(root_folder):
        # Print the current directory
        print(f"üìÅ {os.path.abspath(root)}")

        # Print files in the current directory
        for file in files:
            print(f"    üìÑ {os.path.abspath(os.path.join(root, file))}")

# Replace with the folder you want to scan
folder_path = "/content/drive/MyDrive/PlantWild_Final_EndToEnd_Results"
print_folder_structure(folder_path)